---
title: "Breast cancer data analysis"
author: "Marek Gierlinski"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    css: nice_notebook.css
---

Collaborators: [Sarah Savaridas](https://www.dundee.ac.uk/people/sarah-savaridas), [Andrew Evans](https://www.dundee.ac.uk/people/andrew-evans)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE)
options(dplyr.summarise.inform = FALSE)
```

```{r libs, include=FALSE}
library(nlstools)
library(tidyverse)
library(cowplot)
library(broom)
library(knitr)
library(kableExtra)
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
pdf_dir <- "pdf"
if(!dir.exists(pdf_dir)) dir.create(pdf_dir)
pdf_url <- "http://www.compbio.dundee.ac.uk/user/mgierlinski/breastcancer/pdf/"
```


```{r global_functions}
myKable <- function(df, row.names=FALSE, col.names=NA, digits=2, bootstrap="condensed", font.size=12, label=NULL, caption=NULL) {
  kable(df, format="html", row.names=row.names, col.names=col.names, digits=digits, label=label, caption=caption) %>% kable_styling(bootstrap_options=bootstrap, full_width=FALSE, position="left", font_size=font.size)
}
N <- function(n) prettyNum(n, big.mark = ",")
```

# Data

```{r read_data}
dat <- read_tsv("surv.txt", col_types = cols()) %>% 
  rename(Diagnostic = "Diagnostic route") %>% 
  mutate(Outcome = tolower(Outcome)) %>% 
  filter(Diagnostic != "other" & Age != "16-20" & Age != "21-25") %>% 
  mutate(Diagnostic = recode(Diagnostic, "sympto" = "symptomatic", "screen" = "screening")) %>% 
  mutate_at(vars(Outcome, Diagnostic, Age), as_factor)

sdat <- dat %>% group_by(Outcome, Diagnostic, Age) %>%
  tally %>%
  ungroup %>% 
  separate(Age, c("start", "end"), remove=FALSE) %>% 
  mutate(end = ifelse(end == "", "90", end)) %>% 
  mutate_at(vars(start, end), as.numeric) %>% 
  mutate(Midage = (start - 1 + end)/2) %>% 
  select(-start, -end)
```

We filter input data by removing Outcome = "other" and age ranges 16-20 and 21-25, as they have very few breast cancer deaths. After this filtering we have `r N(nrow(dat))` patients.

We generally group data by Age, Diagnostic and Outcome. Then, we combine various subgroups. Here are the full data group counts:

```{r full_data}
sdat %>% select(Age, Diagnostic, Outcome, n) %>% 
  arrange(Age, Diagnostic, Outcome) %>% 
  myKable %>% scroll_box(width="300px", height="400px")
```


# A few plots



```{r plot_fun}
plotData <- function(d, what="Outcome") {
 d %>% 
  group_by(Age) %>% 
  mutate(p = n / sum(n)) %>% 
  ungroup %>% 
ggplot(aes_string(x=what, y="p")) +
  theme_linedraw() +
  geom_col(aes(fill=Diagnostic)) +
  facet_wrap(~Age, ncol=13) +
  scale_fill_manual(values = cbPalette) +
  theme(axis.text.x = element_text(angle=45, hjust=1), panel.grid = element_blank()) +
  scale_y_continuous(expand=c(0,0), limits=c(0,1))
}
```

## Basic grouping

```{r plot1, fig.width=10, fig.height=3}
sdat %>% 
  plotData
```

## Other deaths together

```{r plot2, fig.width=10, fig.height=3}
sdat %>% 
  mutate(Outcome = recode(Outcome,
                          "indirect_bc_death" = "other death",
                          "unrelated_bc_death" = "other death",
                          "unrelated_death" = "other death")) %>% 
  plotData
```

## Survival excluded

```{r plot3, fig.width=10, fig.height=3}
sdat %>% 
  filter(Outcome != "survival") %>% 
  mutate(Outcome = recode(Outcome,
                          "indirect_bc_death" = "other bc death",
                          "unrelated_bc_death" = "other bc death",
                          "unrelated_death" = "unrelated death")) %>% 
  plotData
```

```{r plot4, fig.width=10, fig.height=3}
sdat %>% 
  filter(Outcome != "survival") %>% 
  mutate(Outcome = recode(Outcome,
                          "indirect_bc_death" = "other death",
                          "unrelated_bc_death" = "other death",
                          "unrelated_death" = "other death")) %>% 
  plotData
```

## All other outcomes together (survival included)

```{r plot5, fig.width=10, fig.height=3}
sdat %>% 
  mutate(Outcome = recode(Outcome,
                          "indirect_bc_death" = "other outcome",
                          "unrelated_bc_death" = "other outcome",
                          "unrelated_death" = "other outcome",
                          "survival" = "other outcome")) %>% 
  plotData
```

## Diagnostic distribution

```{r plot6, fig.width=10, fig.height=3}
sdat %>% 
  plotData(what = "Diagnostic")
```

```{r screen_plot_fun}
plotScreen <- function(d) {
  d %>% 
    group_by(Age, Outcome) %>% 
    summarise(s = sum(n[Diagnostic == "screen"]), tot = sum(n), p = s / tot) %>% 
    ungroup %>% 
ggplot(aes(x=Outcome, y=p)) +
  theme_linedraw() +
  geom_col() +
  facet_wrap(~Age, ncol=13, scales = "free_y") +
  scale_fill_manual(values = cbPalette) +
  theme(axis.text.x = element_text(angle=45, hjust=1), panel.grid = element_blank()) +
    labs(x=NULL, y="Screen proportion")
}
```

```{r plot_screen_1, fig.width=10, fig.height=3, eval=FALSE}
sdat %>% 
  mutate(Outcome = recode(Outcome,
                          "indirect_bc_death" = "other outcome",
                          "unrelated_bc_death" = "other outcome",
                          "unrelated_death" = "other outcome",
                          "survival" = "other outcome")) %>% 
  plotScreen
```

```{r death_plot_fun}
plotDeath <- function(d) {
  d %>% 
    mutate(Diagnostic = recode(Diagnostic, "sympto" = "unscreened", "other" = "unscreened")) %>% 
    group_by(Age, Diagnostic) %>% 
    summarise(s = sum(n[Outcome == "direct_bc_death"]), tot = sum(n), f = tot - s, p = s / tot) %>%
    mutate(lab = paste0(s, "/", tot)) %>% 
    ungroup %>% 
  ggplot(aes(x=Diagnostic, y=p)) +
    theme_linedraw() +
    geom_col(fill="goldenrod", colour="black") +
    facet_wrap(~Age, ncol=7, scales = "free_y") +
    scale_fill_manual(values = cbPalette) +
    theme(axis.text.x = element_text(angle=45, hjust=1), panel.grid = element_blank()) +
    labs(x=NULL, y="Direct BC death proportion") +
    geom_text(aes(label = lab), vjust=1.2, size=3)
}
```

## Direct BC death vs diagnostic

These plots include actual counts in each proportion.

```{r plot_death_1, fig.width=10, fig.height=4}
sdat %>% 
  plotDeath
```


# Proportion analysis

Here, we group data by age and diagnostic route. In each age group we find a proportion of either direct BC deaths or unrelated deaths with respect to all types of deaths or all possible outcomes.

## Proportion plots

These proportions are shown in plots below. Error bars are standard errors of a proportion:

\[SE_i = \sqrt{\frac{p_i(1-p_i)}{n_i}},\]

where $p_i$ is the proportion of selected cases and $n_i$ is the total number of cases, $i$ is the age group index.

```{r find_proportion_function}
findOutcomeProportion <- function(d, value, others) {
  ds <- d %>% 
    group_by(Diagnostic, Age) %>% 
    summarise(s = sum(n[Outcome == value]), f = sum(n[Outcome %in% others]), n = s + f,  p = s / n, Midage = Midage[1]) %>%
    filter(s > 0 & f > 0) %>% 
    ungroup
  
  properr <- ds %>%
    mutate(row = row_number()) %>% 
    group_by(row) %>%
    do({
      ci <- suppressWarnings(prop.test(.$s, .$n)$conf.int)
      se <- sqrt(.$p * (1 - .$p) / .$n)
      tibble(p_lo = ci[1], p_up = ci[2], se = se)
    }) %>% 
    ungroup
  
  bind_cols(ds, select(properr, p_lo, p_up, se))
}

plotOutcomeProportion <- function(d, value, others, tit=NULL, err="se") {
  if(is.null(tit)) tit <- paste(value, "proportion")
  pd <- position_dodge(width=0.35)
  d <- d %>% 
    findOutcomeProportion(value, others)
  if(err == "se") {
    d <- d %>% mutate(p_lo = p - se, p_up = p + se)
  }
  ggplot(d, aes(x=Age, y=p, group=Diagnostic, colour = Diagnostic)) +
    theme_linedraw() +
    theme(panel.grid = element_blank(), axis.text.x=element_text(angle=45, hjust=1)) +
    geom_errorbar(aes(x=Age, ymin=p_lo, ymax=p_up, colour=Diagnostic), width=0.35, position=pd) +
    geom_point(size=1.5, position=pd) +
    geom_vline(xintercept = seq(0.5,20,1), colour="grey90") +
    labs(x = "Age group", y = "Proportion", title=tit) +
    scale_colour_manual(values = cbPalette) +
    scale_y_continuous(limits=c(0,1))
}
```

```{r cases}
cases <- list(
  `1` = list(value = "direct_bc_death",
             others = c("indirect_bc_death", "unrelated_death", "unrelated_bc_death"),
             name = "Direct BC deaths / all deaths"),
  `2` = list(value = "unrelated_death",
             others = c("indirect_bc_death", "direct_bc_death", "unrelated_bc_death"),
             name = "Unrelated deaths / all deaths"),
  `3` = list(value = "direct_bc_death",
             others = c("indirect_bc_death", "unrelated_death", "unrelated_bc_death", "survival"),
             name = "Direct BC deaths / all outcomes"),
  `4` = list(value = "unrelated_death",
             others = c("indirect_bc_death", "direct_bc_death", "unrelated_bc_death", "survival"),
             name = "Unrelated deaths / all outcomes")
)
```

```{r age_death_bc_proportion, fig.width=6, fig.height=12, error=FALSE, message=FALSE}
map(cases, function(case) {
  plotOutcomeProportion(sdat, value = case$value, others = case$others, tit = case$name, err="se")   
}) %>% 
  plot_grid(plotlist = ., ncol=1)  
```

We see that screened patients consistently show lower breast cancer death proportion at most age groups. The unrelated deaths / all deaths are higher for screened patients, because these are essentially the inversion of the BC deaths (that is, unrelated deaths and BC deaths add up to total deaths, apart from two other categories - indirect BC death and unrelated BC death).

When we find the proportion of all outcomes, the result is much more independent. The BC deaths are much higher in symptomatic patients but unrelated deaths show very little difference between screened and symptomatic patients - this is encouraging!

## Statistical significance

Next we assess the statistical different between symptoms and screening for each plot. For this, we use a test statistic:

\[\chi^2 = \sum_{i=1}^m \frac{(p_{1,i} - p_{2,i})^2}{SE_i^2},\]

which is approximately $\chi^2$ distributed with $m-1$ degrees of freedom, where $m$ is the number of age groups used (we ignore groups where any of the counts are zero). Here $i$ is the age group index, $p_1$ and $p_2$ are proportions of deaths in symptoms and screening diagnostics, respectively and the pooled standard error, $SE_i$ is approximated by

\[SE_i^2 = SE_{1,i}^2 + SE_{2,i}^2,\]

that is from individual standard errors of each proportion. This is a conservative approximation as it is not weighted by the sample size and it will tend to overestimate errors when one of the standard errors is much larger than the other. As a result, $\chi^2$ is reduced and the $p$-value is inflated.


```{r chi2_comparison}
chi2Comparison <- function(d, value, others) {
  P <- d %>% 
    findOutcomeProportion(value, others) %>% 
    select(Age, Diagnostic, p, se) %>% 
    group_split(Diagnostic)
  cx <- inner_join(P[[1]], P[[2]], by="Age") %>% 
    mutate(se2 = se.x^2 + se.y^2, chi2 = (p.x - p.y)^2 / se2)
  chi2 <- sum(cx$chi2)
  dof <- nrow(cx) - 1
  p <- 1 - pchisq(chi2, dof)
  list(chi2 = chi2, dof = dof, p = p)
}
```


```{r chi2_table}
map_df(cases, function(case) {
  cs <- chi2Comparison(sdat, value = case$value, others = case$others)
  tibble(Group = case$name, chi2 = cs$chi2, p = cs$p)
}) %>% 
  mutate_at(vars(chi2, p), ~signif(.,3)) %>% mutate_at(vars(chi2, p), as.character) %>% 
  myKable()
```

As we mostly see very small p-values (practically zero) the p-value inflation is not a problem. We see that the first free cases are very strongly statistically significant while in the last case, which is still statistically significant at the default 0.05 limit, the effect size (can be quantified by $\chi^2$) is much smaller.

## Statistical significance per age group (direct BC deaths / all)

Now we compare proportion direct BC deaths vs all between screening and symptomatic, in each age group separately. We use Fisher's test and correct p-values for multiple tests using Benjamini-Hochberg approach. The adjusted p-value is a false discovery rate (FDR).

```{r bc_fisher}
make_fisher_tables <- function(d) {
  map_dfr(cases, function(case) {
    c_screen <- d %>%
    filter(Diagnostic=="screening") %>% 
    findOutcomeProportion(case$value, case$others)
  c_sym <- sdat %>%
    filter(Diagnostic=="symptomatic") %>% 
    findOutcomeProportion(case$value, case$others)
  c_join <- inner_join(c_screen, c_sym, by="Age") %>% 
    nest(data = c(s.x, f.x, s.y, f.y)) %>% 
    mutate(
      test = map(data, ~fisher.test(matrix(c(.x$s.x, .x$s.y, .x$f.x, .x$f.y), nrow=2))),
      tidied = map(test, tidy)
    ) %>% 
    unnest(c(tidied, data)) %>% 
    rename(bc_screen = s.x, all_screen = n.x, bc_sym = s.y, all_sym = n.y, odds_ratio=estimate) %>% 
    mutate(case = case$name)
    c_join$FDR <- p.adjust(c_join$p.value, method="BH")
    c_join
  })
}

d_fish <- make_fisher_tables(sdat)

d_sel <- d_fish %>% 
  select(case, Age, bc_screen, all_screen, bc_sym, all_sym, odds_ratio, p.value, FDR)

nm <- map(cases, ~.x$name) %>% unlist()

d_sel %>% filter(case == nm[1]) %>% select(-case) %>% myKable(caption=nm[1])
d_sel %>% filter(case == nm[2]) %>% select(-case) %>% myKable(caption=nm[2])
d_sel %>% filter(case == nm[3]) %>% select(-case) %>% myKable(caption=nm[3])
d_sel %>% filter(case == nm[4]) %>% select(-case) %>% myKable(caption=nm[4])
```



We see that screening patients have lower BC/all deaths in age groups 51-80, while in other groups counts are too small to make any judgment.

# Conclusion

Direct BC death proportions are much smaller in screened patients than in the symptomatic patients. The effect cannot be attributed to general differences between the two groups, e.g. because of a healthier life style. When we look at unrelated deaths, the difference between the two groups are much smaller.


# Alternative visualization

I replace are range with the middle of the range and fit numerical data with a third-degree polynomial, taking standard errors into account. Here is what the models look like. Errors are standard errors.


```{r fit_funs}
fitPoly <- function(d, value, others, ...) {
  d %>% 
    findOutcomeProportion(value, others) %>% 
    select(x=Midage, y=p, se, Diagnostic) %>% 
    group_split(Diagnostic) %>% 
    map_df(function(w) {
      m <- nls(y ~ A + B*x + C*x^2 + D*x^3, start=list(A=0.2, B=0, C=0, D=0), weights=1/se^2, data=w)
      xd <- tibble(x=seq(min(w$x),max(w$x),1))
      tibble(Diagnostic=w$Diagnostic[1], x=xd$x, y=predict(m, xd))
    })
}

plotFitData <- function(d, value, others, FITFUN=fitPoly, ..., tit=NULL, with.smooth=FALSE, min.age=35, max.y=1, level=0.95) {
  if(is.null(tit)) tit <- paste(value, "proportion")
  
  dat <- d %>% 
    findOutcomeProportion(value, others)
  
  g <- ggplot(data=dat, aes(x=Midage, y=p, group=Diagnostic, colour = Diagnostic)) +
    theme_linedraw() +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank()
    ) +
    geom_errorbar(aes(x=Midage, ymin=p-se, ymax=p+se, colour=Diagnostic), width=0.2) +
    geom_point(size=1.5) +
    labs(x = "Age group", y = "Proportion", title=tit) +
    scale_colour_manual(values = cbPalette) +
    scale_y_continuous(limits=c(0,max.y), expand=c(0,0))

  if(!is.null(FITFUN)) {
    mod <- FITFUN(d, value, others, ...)
    g <- g +   geom_line(data=mod, aes(x=x, y=y, colour=Diagnostic))
  }
  if(with.smooth) {
    g <- g + geom_smooth(data=filter(dat, Midage>min.age), method="lm", colour="black", size=0.5, level=level)
  }
  g
}
```


```{r age_model, fig.width=6, fig.height=12}
map(cases, function(case) {
  plotFitData(sdat, value = case$value, others = case$others, tit = case$name)   
}) %>%  
  plot_grid(plotlist = ., ncol=1)
```


# Over 75

Below I re-create fig. 3 from the manuscript, that is the outcome for patients over 71. I create three versions of this figure, showing total counts, proportion and stacked proportion. The total count figure shows that the two groups of patients are unbalanced. We should consider if this can affect the outcome proportions.

Note that the proportion plot includes error bars (95% confidence intervals), which we should show in the paper. These are errors of a proportion. It is almost impossible to plot error bars in a stacked plot.

```{r over75_data}
groupAge <- function(d) {
  d <- d %>% 
    mutate(Outcome = recode(Outcome, "unrelated_bc_death" = "unrelated_death")) %>% 
    group_by(Diagnostic, Outcome) %>% 
    summarise(n = sum(n)) %>% 
    ungroup %>% 
    group_by(Diagnostic) %>% 
    mutate(p = n / sum(n), tot = sum(n)) %>%
    ungroup

  err <- map_df(1:nrow(d), function(i) {
    r <- d[i, ]
    conf <- prop.test(r$n, r$tot, conf.level=0.95)$conf.int
    tibble(p_lo = conf[1], p_up = conf[2])
  })

  bind_cols(d, err)
}

d75 <- groupAge(filter(sdat, Midage > 75))
```

```{r over_75_plot2, fig.width=4, fig.height=3}
plotGroupAge <- function(d, what="count", pos="dodge", x="Diagnostic", group="Outcome", ymax=NA) {
  d <- d %>%
    mutate(Outcome = recode_factor(Outcome, 
                                    "direct_bc_death" = "Direct BC death",
                                    "indirect_bc_death" = "Indirect BC death",
                                    "unrelated_death" = "Unrelated death",
                                    "survival" = "Survival"
                                   )) %>% 
  mutate(
      x = !!as.name(x),
      group = !!as.name(group),
      y = if(what == "count") n else p
  )


  if(!is.null(ymax)) {
    max.y <- ymax
  } else if(pos == "stack") {
    max.y <- 1.05
  } else if(what == "count") {
    max.y <- max(d$y) * 1.03
  } else {
    max.y <- max(d$p_up) * 1.03
  }
  
  g <- ggplot(d, aes(x=x, y=y, group=group, fill=group)) +
    geom_col(position = pos, width=0.6, colour="grey30") +
    theme_bw() +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank()
    ) +
    scale_fill_manual(values=cbPalette) +
    scale_y_continuous(expand=c(0,0), limits=c(0, max.y)) +
    labs(x=NULL, y=what)
  if(pos == "dodge" & what == "proportion") {
    g <- g + geom_errorbar(aes(ymin=p_lo, ymax=p_up), position=position_dodge(width=0.6), width=0.2, colour="grey30")
  }
  g
}


plotGroupAge(d75, what="count")
plotGroupAge(d75, what="proportion")
plotGroupAge(d75, what="proportion", pos="stack")

dfi <- d75 %>% mutate(not_n = tot - n) %>% filter(Outcome == "unrelated_death")
ftab <- select(dfi, n, not_n) %>% as.matrix
ft <- fisher.test(ftab, alternative="greater")
```

The unrelated death proportion is greater in the symptomatic patients. The difference is statistically significant, $p = `r signif(ft$p.value, 2)`$. The odds ratio (the effect size when comparing proportions) is `r signif(ft$estimate, 2)`.

Below I repeat the above calculations for each age group (above 75) separately. As we can see, the difference in unrelated deaths is less convincing per group (overlapping error bars), only becomes pronounced when they are pooled. Also, the number of screened patients become very small at later ages.

```{r age_comparison, fig.width=10, fig.height=3}
plotAgeComparison <- function(d, ages=c("71-75", "76-80", "81-85", "86+"), what="proportion") {
  map(ages, function(age) {
    d %>% 
      filter(Age == age) %>% 
      groupAge %>% 
      plotGroupAge(what=what) +
        ggtitle(age) +
        theme(legend.position = "none")
  }) %>% 
    plot_grid(plotlist=., nrow=1)
}

plotAgeComparison(sdat, what="count")
plotAgeComparison(sdat, what="proportion")
```

Below I repeat the figure showing outcome proportion for all age groups. Instead of standard error I plot 95% confidence intervals and change the vertical axis range to zoom into the data. It shows very little difference between the two diagnostics, when all ages trend is taken into account.

```{r plot_again}
plotOutcomeProportion(sdat, value = cases[[4]]$value, others = cases[[4]]$others, tit = cases[[4]]$name, err="ci") + coord_cartesian(ylim=c(0,0.5))
```

Incidentally, there is a bigger difference in the 56-60 age group than in 66-70, while there is not enough screening data from the 61-65 group.

My feeling is that though there is a statistically significant difference in unrelated deaths between the two diagnostics, it only becomes apparent when data are pooled over four age groups. When looking at individual groups and a whole-age trend, this is less convincing. The symptomatic data have enough counts and the trend is clear with small error bars. The screened patient data are simply too small - it is very noisy and the age trend is not clear.

## Alternative plot

If we want to talk about the difference in unrelated deaths, this plot shows it more directly. In the right panel I show a "control", which is all the patients aged 26-70. It is interesting to notice that unrelated deaths are the other way around, while all other outcomes have the same direction of change.

```{r alternative_75, fig.width=10, fig.height=4}
g1 <- plotGroupAge(d75, what="proportion", x="Outcome", group="Diagnostic") + theme(axis.text.x = element_text(angle=45, hjust=1)) + ggtitle("75+")
g2 <- sdat %>% filter(Midage < 75) %>% groupAge %>% plotGroupAge(what="proportion", x="Outcome", group="Diagnostic") + theme(axis.text.x = element_text(angle=45, hjust=1)) + ggtitle("26-70")

plot_grid(g1, g2, nrow=1)
```

Perhaps there is something in it...

```{r fisher_75}
d <- d75 %>%
  mutate(s = tot - n) %>% 
  pivot_wider(id_cols=Outcome, names_from=Diagnostic, values_from=c(n, s)) %>% 
  nest(data = -Outcome) %>% 
  mutate(
    test = map(data, ~fisher.test(matrix(c(.x$n_symptomatic, .x$s_symptomatic, .x$n_screening, .x$s_screening), nrow=2))),
    tidied = map(test, tidy)
  ) %>% 
  unnest(c(tidied, data)) %>% 
  select(-c(test, method, alternative))
d$FDR <- p.adjust(d$p.value, method="BH")
myKable(d)
```

Adjusted p-value for unrelated deaths is `r sprintf("%s", signif(d[3,]$FDR, 2))`.

## Cancer deaths vs unrelated deaths

Let us summarise deaths in symptomatic and screening patients.

```{r cancer_unrelated_deaths_75}
death_propotions <- function(d) {
  d %>%
    #mutate(Outcome = recode(Outcome, direct_bc_death="bc_death", indirect_bc_death="bc_death")) %>% 
    group_by(Outcome, Diagnostic) %>%
    summarise(count = sum(n)) %>%
    ungroup() %>% 
    group_by(Diagnostic) %>% 
    mutate(total = sum(count), prop = count / total) %>%
    ungroup() %>% 
    pivot_wider(id_cols=Diagnostic, names_from=Outcome, values_from=c(count, prop))
}

bc_outcome <- sdat %>%
  filter(Midage > 75) %>% 
  death_propotions()

myKable(bc_outcome, caption="Cancer deaths vs unrelated deaths, age > 75")

fisher.test(bc_outcome %>% select(count_direct_bc_death, count_unrelated_death))
```

We see that in the 75+ age group proportion of breast cancer deaths (direct and indirect) is reduced from 42% for symptomatic patients to 10% for screening patients. At the same time unrelated deaths are 22% and 14%, respectively. The difference between these two proportions is strongly significant ($p=3\times10^{-9}$, Fisher's test).

Just for comparison, the same proportions, but for 71-75 group:

```{r cancer_unrelated_deaths_71}
bc_outcome_71 <- sdat %>%
  filter(Age == "71-75") %>% 
  death_propotions()

p_sc <- bc_outcome_71$prop_direct_bc_death[2]


myKable(bc_outcome_71, caption="Cancer deaths vs unrelated deaths, 71-75")

fisher.test(bc_outcome_71 %>% select(count_direct_bc_death, count_unrelated_death))

```

## Lead-time and length-bias correction

Lead-time and length-bias corrections can increase screen-detected breast cancers. Without full distribution of survival times it is hard to do exact calculations. I only information if the patient died, but not how long after diagnosis; from your description it seems we don't have the same time period for all patients, as 10 years in Duffy at al., so it would be hard to apply their approach accurately, but Duffy et al. show that in a similar case a 10-year fatality of screen-detected breast cancers increased from 0.12 to 0.18, that is by about a half.

If a similar correction were to be applied to our data, it would increase proportion of screened cancer deaths from `r signif(p_sc, 2)` to about `r signif(p_sc * 0.18 / 0.12, 2)`. This is not enough to account for the observed difference between screened and symptomatic patients in our data.

By the way, there are serious mistakes in the Duffy et al., unless I don't understand simple ratios. Have a look at their table 2. Total number of screened cancers is 10,100, number of deaths in 10 years is 819 and they quote 10-year fatality rate as 0.12. But 819 / 10100 = 0.08. The same problem is for symptomatic patients. Either "fatality rate" is defined somehow different that deaths / cases, there are mistakes in the paper, which makes it hard to follow and understand what they do.

# Age dependence of BC deaths

Here we look how proportion of direct breast cancer deaths (vs all deaths) changes as a function of age. I do the calculation twice: once for symptomatic patients only, and then for all patients. Screened patients don't show a simple linear decrease.

From figures above we notice that the proportion of BC deaths decreases with age only above the age of about 35. Hence, we fit only ages 35+ with a linear regression.

We use linear regression parameterised as

\[y = \frac{1}{2} - t_{1/2} \beta + \beta x,\]

where $\beta$ is the slope and $t_{1/2}$ is the age at which model propotion is $\frac{1}{2}$. This is just a straight line, but instead of slope and intercept we have slope and half-life. This model representation allows us to estimate half-life uncertainty directly from the fit.

Plots show the best fit, tables show regression parameters. The error bars on data are standard errors.

```{r time_course_fit}
# we fit data with a straight line parametrized by
# slope and age at which proportion is 0.5 (parameter Half).
# This allows us to calculate the error of the half-life
timeCourseFit <- function(d, value, others, min.age) {
 dx <- d %>%  
    findOutcomeProportion(value, others) %>% 
    filter(Midage >= min.age) %>% 
    select(x = Midage, y = p, se)
 m = nls(y ~ 0.5 - Slope*Half + Slope*x, start=list(Slope=-0.1, Half=70), weights=1/se^2, data=dx)
 cbind(summary(m)$coefficients, confint2(m)) %>% 
   as.data.frame %>%
   rownames_to_column(var="Parameter")
}

timeCourse <- function(d, value, others, min.age=37.5, tit=NULL, with.half=FALSE) {
  # fit time course with a linear function, using nls to include errors
  coef <- timeCourseFit(d, value, others, min.age=min.age)
  slope <- coef$Estimate[1]
  half <- coef$Estimate[2]
  half.err <- (coef$`97.5 %`[2] - coef$`2.5 %`[2]) / 2

  xx <- c(min.age, 87.5)
  mod <- tibble(x = xx, y = 0.5 - slope*half + xx * slope)
  g <- plotFitData(d, value, others, FITFUN=NULL, tit=tit) +
    geom_line(data=mod, aes(x=x, y=y), group=1, colour=1)
  if(with.half) {
    g <- g + 
      #geom_tile(x=halfx, width=halfx.err, y=0.5, height=0.5, fill="grey80") +
      geom_vline(xintercept = half, linetype = "dotted", colour="grey50")
  }
  list(plot=g, coef=coef, half=half, half.err=half.err)
}
```

```{r time_course_symptoms, fig.width=6, fig.height=3}
d_sym <- sdat %>%
  filter(Diagnostic=="symptomatic")
tc_sym <- timeCourse(d_sym, cases[[1]]$value, cases[[1]]$others, tit=cases[[1]]$name, with.half = TRUE)
tc_sym$plot 
tc_sym$coef %>% mutate_at(vars(-Parameter), ~sprintf("%.3g", .)) %>% myKable
```

The vertical line corresponds to the model = 0.5 and the age for this is `r round(tc_sym$half, 0)`  $\pm$ `r round(tc_sym$half.err, 0)` years (95% confidence interval).

```{r time_course_both, fig.width=6, fig.height=3}
d_both <- sdat %>% 
  group_by(Age, Outcome) %>% 
  summarise(n = sum(n), Midage = Midage[1]) %>% 
  mutate(Diagnostic = "both")
tc_both <- timeCourse(d_both, cases[[1]]$value, cases[[1]]$others, tit=cases[[1]]$name, with.half = TRUE)
tc_both$plot 
tc_both$coef %>% mutate_at(vars(-Parameter), ~sprintf("%.3g", .)) %>% myKable 
```

In both cases the decrease in direct BC deaths proportion is about $0.012\pm0.001$, that is $(1.2\pm0.1)\%$ per year (95% condfidence interval). Also, a small p-value on the slope indicates that the decrease with age is highly significant.

```{r time_course_screening, fig.width=6, fig.height=3}
d_screen <- sdat %>%
  filter(Diagnostic=="screening")
tc_screen <- timeCourse(d_screen, cases[[1]]$value, cases[[1]]$others, tit=cases[[1]]$name, with.half = TRUE)
tc_screen$plot 
tc_screen$coef %>% mutate_at(vars(-Parameter), ~sprintf("%.3g", .)) %>% myKable
```

# Publication figures

```{r mortality, fig.width=5, fig.height=3}
ds <- sdat %>% 
  group_by(Age) %>% 
  summarise(s = sum(n[Outcome != "survival"]), n = sum(n), p = s / n)

properr <- ds %>%
    mutate(row = row_number()) %>% 
    group_by(row) %>%
    do({
      ci <- suppressWarnings(prop.test(.$s, .$n)$conf.int)
      se <- sqrt(.$p * (1 - .$p) / .$n)
      tibble(p_lo = ci[1], p_up = ci[2], se = se)
    }) %>% 
    ungroup
ds <- bind_cols(ds, select(properr, p_lo, p_up, se))

g <- ggplot(ds, aes(x=Age, y=p)) +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle=40, hjust=1)
  ) +
  geom_errorbar(aes(ymin=p_lo, ymax=p_up), width=0.2) +
  geom_point() +
  labs(x="Age group", y="Mortality")
g

file <- "mortality.pdf"
link_mortality <- paste0(pdf_url, file)
ggsave(file.path(pdf_dir, file), plot = g, device = "pdf", width=4, height=3)
```

[Download](`r link_mortality`)



```{r fig_assessment, fig.width=4, fig.height=2.5}
ass71 <- tribble(
  ~assessment, ~n,
  "High risk", 122,
  "Intermediate risk", 396,
  "Low risk", 143,
  #"Invasivness/grade unknown", 17,
  "Benign biopsy", 293,
  "Further imaging only", 1309
) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(assessment = as_factor(assessment))

g <- ggplot(ass71, aes(x=fct_rev(assessment), y=n)) +
  theme_bw() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank()
  ) +
  geom_col() +
  geom_text(aes(label=n), hjust=0, nudge_y = 15, size=2.6) +
  coord_flip() +
  scale_y_continuous(expand=c(0,0), limits=c(0, max(ass71$n)*1.14)) +
  labs(x=NULL, y="Patient count")
g

file <- "assessment.pdf"
link_ass <- paste0(pdf_url, file)
ggsave(file.path(pdf_dir, file), plot = g, device = "pdf", width=4, height=2.5)
```

[Download](`r link_ass`)


```{r fig_screen_sym_proportions, fig.width=8, fig.height=5}
pd <- position_dodge(width=0.35)
d <- map_dfr(cases, function(case) {
  findOutcomeProportion(sdat, case$value, case$others) %>% 
    mutate(case = case$name)
})
g <- ggplot(d, aes(x=Age, y=p, group=Diagnostic, colour = Diagnostic)) +
    theme_linedraw() +
    theme(panel.grid = element_blank(), axis.text.x=element_text(angle=45, hjust=1)) +
    geom_errorbar(aes(x=Age, ymin=p_lo, ymax=p_up, colour=Diagnostic), width=0.35, position=pd) +
    geom_point(size=1.5, position=pd) +
    geom_vline(xintercept = seq(0.5,20,1), colour="grey90") +
    labs(x = "Age group", y = "Proportion") +
    scale_colour_manual(values = cbPalette) +
    scale_y_continuous(limits=c(0,1)) +
  facet_wrap(~case, ncol=2)
g

file <- "screen_sym_proportions.pdf"
link_ss <- paste0(pdf_url, file)
ggsave(file.path(pdf_dir, file), plot = g, device = "pdf", width=8, height=5)
```

[Download](`r link_ss`)

```{r fig_death_prop, fig.width=9, fig.height=3}
plotDeathProp <- function(d, min.age=37.5) {
  value <- cases[[1]]$value
  others <- cases[[1]]$others
  
  dat <- d %>% 
    findOutcomeProportion(value, others)
  coef <- timeCourseFit(d, value, others, min.age=min.age)
  slope <- coef$Estimate[1]
  half <- coef$Estimate[2]

  xx <- c(min.age, 87.5)
  mod <- tibble(x = xx, y = 0.5 - slope*half + xx * slope)

  ggplot(data=dat, aes(x=Midage, y=p)) +
    theme_bw() +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank()
    ) +
    geom_errorbar(aes(x=Midage, ymin=p-se, ymax=p+se), width=1) +
    geom_point(size=1.5) +
    labs(x = "Age", y = "Proportion of deaths directly due to BC") +
    scale_y_continuous(limits=c(0, 1), expand=c(0, 0)) +
    geom_line(data=mod, aes(x=x, y=y), group=1) +
    geom_vline(xintercept = half, linetype = "dotted", colour="grey50") +
    scale_x_continuous(expand=c(0,0), limits=c(25,95))
}

g1 <- plotDeathProp(d_both) + labs(title="All patients")
g2 <- plotDeathProp(d_sym) + labs(title="Symptomatic patients", y=NULL)
g3 <- plotDeathProp(d_screen) + labs(title="Screened patients", y=NULL)
g <- plot_grid(g1, g2, g3, nrow=1, align="h")
g

file <- "death_proportion.pdf"
link_death <- paste0(pdf_url, file)
ggsave(file.path(pdf_dir, file), plot = g, device = "pdf", width=9, height=3)
```

[Download](`r link_death`)

```{r outcome_plot, fig.width=8, fig.height=3}
g1 <- sdat %>% filter(Midage < 75) %>% groupAge() %>% plotGroupAge(what="proportion", x="Outcome", group="Diagnostic", ymax=1) + theme(axis.text.x = element_text(angle=40, hjust=1)) + ggtitle("26-75") + theme(legend.position = "none") +  labs(y="Proportion", fill="Diagnostic route")

g2 <- sdat %>% filter(Midage > 75) %>% groupAge() %>% plotGroupAge(what="proportion", x="Outcome", group="Diagnostic", ymax=1) + theme(axis.text.x = element_text(angle=40, hjust=1)) + ggtitle("76+") + labs(y=NULL)



g <- plot_grid(g1, g2, nrow=1, align = "h", rel_widths = c(1,1.3))
g

file <- "outcome.pdf"
link_outcome <- paste0(pdf_url, file)
ggsave(file.path(pdf_dir, file), plot = g, device = "pdf", width=8, height=3)
```

[Download](`r link_outcome`)