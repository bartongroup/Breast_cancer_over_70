---
title: "Breast cancer data analysis"
author: "Marek Gierlinski"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    css: nice_notebook.css
---

Collaborators: [Sarah Savaridas](https://www.dundee.ac.uk/people/sarah-savaridas), [Andrew Evans](https://www.dundee.ac.uk/people/andrew-evans)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE)
library(tidyverse)
library(cowplot)
library(knitr)
library(kableExtra)
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```


```{r global_functions}
myKable <- function(df, row.names=FALSE, col.names=NA, digits=2, bootstrap="condensed", font.size=12, label=NULL) {
  kable(df, format="html", row.names=row.names, col.names=col.names, digits=digits, label=label) %>% kable_styling(bootstrap_options=bootstrap, full_width=FALSE, position="left", font_size=font.size)
}
N <- function(n) prettyNum(n, big.mark = ",")
```

# Data

```{r read_data}
dat <- read_tsv("surv.txt", col_types = cols()) %>% 
  rename(Diagnostic = "Diagnostic route") %>% 
  mutate(Outcome = tolower(Outcome)) %>% 
  filter(Diagnostic != "other" & Age != "16-20" & Age != "21-25") %>% 
  mutate(Diagnostic = recode(Diagnostic, "sympto" = "symptoms", "screen" = "screening")) %>% 
  mutate_at(vars(Outcome, Diagnostic, Age), as_factor)

sdat <- dat %>% group_by(Outcome, Diagnostic, Age) %>%
  tally %>%
  ungroup %>% 
  separate(Age, c("start", "end"), remove=FALSE) %>% 
  mutate(end = ifelse(end == "", "90", end)) %>% 
  mutate_at(vars(start, end), as.numeric) %>% 
  mutate(Midage = (start - 1 + end)/2) %>% 
  select(-start, -end)
```

We filter input data by removing Outcome = "other" and age ranges 16-20 and 21-25, as they have very few breast cancer deaths. After this filtering we have `r N(nrow(dat))` patients.

We generally group data by Age, Diagnostic and Outcome. Then, we combine various subgroups. Here are the full data group counts:

```{r full_data}
sdat %>% select(Age, Diagnostic, Outcome, n) %>% 
  arrange(Age, Diagnostic, Outcome) %>% 
  myKable %>% scroll_box(width="300px", height="400px")
```


# A few plots



```{r plot_fun}
plotData <- function(d, what="Outcome") {
 d %>% 
  group_by(Age) %>% 
  mutate(p = n / sum(n)) %>% 
  ungroup %>% 
ggplot(aes_string(x=what, y="p")) +
  theme_linedraw() +
  geom_col(aes(fill=Diagnostic)) +
  facet_wrap(~Age, ncol=13) +
  scale_fill_manual(values = cbPalette) +
  theme(axis.text.x = element_text(angle=45, hjust=1), panel.grid = element_blank()) +
  scale_y_continuous(expand=c(0,0), limits=c(0,1))
}
```

## Basic grouping

```{r plot1, fig.width=10, fig.height=3}
sdat %>% 
  plotData
```

## Other deaths together

```{r plot2, fig.width=10, fig.height=3}
sdat %>% 
  mutate(Outcome = recode(Outcome,
                          "indirect_bc_death" = "other death",
                          "unrelated_bc_death" = "other death",
                          "unrelated_death" = "other death")) %>% 
  plotData
```

## Survival excluded

```{r plot3, fig.width=10, fig.height=3}
sdat %>% 
  filter(Outcome != "survival") %>% 
  mutate(Outcome = recode(Outcome,
                          "indirect_bc_death" = "other bc death",
                          "unrelated_bc_death" = "other bc death",
                          "unrelated_death" = "unrelated death")) %>% 
  plotData
```

```{r plot4, fig.width=10, fig.height=3}
sdat %>% 
  filter(Outcome != "survival") %>% 
  mutate(Outcome = recode(Outcome,
                          "indirect_bc_death" = "other death",
                          "unrelated_bc_death" = "other death",
                          "unrelated_death" = "other death")) %>% 
  plotData
```

## All other outcomes together (survival included)

```{r plot5, fig.width=10, fig.height=3}
sdat %>% 
  mutate(Outcome = recode(Outcome,
                          "indirect_bc_death" = "other outcome",
                          "unrelated_bc_death" = "other outcome",
                          "unrelated_death" = "other outcome",
                          "survival" = "other outcome")) %>% 
  plotData
```

## Diagnostic distribution

```{r plot6, fig.width=10, fig.height=3}
sdat %>% 
  plotData(what = "Diagnostic")
```

```{r screen_plot_fun}
plotScreen <- function(d) {
  d %>% 
    group_by(Age, Outcome) %>% 
    summarise(s = sum(n[Diagnostic == "screen"]), tot = sum(n), p = s / tot) %>% 
    ungroup %>% 
ggplot(aes(x=Outcome, y=p)) +
  theme_linedraw() +
  geom_col() +
  facet_wrap(~Age, ncol=13, scales = "free_y") +
  scale_fill_manual(values = cbPalette) +
  theme(axis.text.x = element_text(angle=45, hjust=1), panel.grid = element_blank()) +
    labs(x=NULL, y="Screen proportion")
}
```

```{r plot_screen_1, fig.width=10, fig.height=3, eval=FALSE}
sdat %>% 
  mutate(Outcome = recode(Outcome,
                          "indirect_bc_death" = "other outcome",
                          "unrelated_bc_death" = "other outcome",
                          "unrelated_death" = "other outcome",
                          "survival" = "other outcome")) %>% 
  plotScreen
```

```{r death_plot_fun}
plotDeath <- function(d) {
  d %>% 
    mutate(Diagnostic = recode(Diagnostic, "sympto" = "unscreened", "other" = "unscreened")) %>% 
    group_by(Age, Diagnostic) %>% 
    summarise(s = sum(n[Outcome == "direct_bc_death"]), tot = sum(n), f = tot - s, p = s / tot) %>%
    mutate(lab = paste0(s, "/", tot)) %>% 
    ungroup %>% 
  ggplot(aes(x=Diagnostic, y=p)) +
    theme_linedraw() +
    geom_col(fill="goldenrod", colour="black") +
    facet_wrap(~Age, ncol=7, scales = "free_y") +
    scale_fill_manual(values = cbPalette) +
    theme(axis.text.x = element_text(angle=45, hjust=1), panel.grid = element_blank()) +
    labs(x=NULL, y="Direct BC death proportion") +
    geom_text(aes(label = lab), vjust=1.2, size=3)
}
```

## Direct BC death vs diagnostic

These plots include actual counts in each proportion.

```{r plot_death_1, fig.width=10, fig.height=4}
sdat %>% 
  plotDeath
```


# Proportion analysis

Here, we group data by age and diagnostic route. In each age group we find a proportion of either direct BC deaths or unrelated deaths with respect to all types of deaths or all possible outcomes.

## Proportion plots

These proportions are shown in plots below. Error bars are standard errors of a proportion:

\[SE_i = \sqrt{\frac{p_i(1-p_i)}{n_i}},\]

where $p_i$ is the proportion of selected cases and $n_i$ is the total number of cases, $i$ is the age group index.

```{r find_proportion_function}
findOutcomeProportion <- function(d, value, others) {
  ds <- d %>% 
    group_by(Diagnostic, Age) %>% 
    summarise(s = sum(n[Outcome == value]), f = sum(n[Outcome %in% others]), n = s + f,  p = s / n, Midage = Midage[1]) %>%
    filter(s > 0 & f > 0) %>% 
    ungroup
  
  properr <- ds %>%
    mutate(row = row_number()) %>% 
    group_by(row) %>%
    do({
      #ci <- prop.test(.$s, .$n)$conf.int
      #tibble(p_lo = ci[1], p_up = ci[2])
      se <- sqrt(.$p * (1 - .$p) / .$n)
      tibble(p_lo = .$p - se, p_up = .$p + se, se = se)
    }) %>% 
    ungroup
  
  bind_cols(ds, select(properr, p_lo, p_up, se))
}

plotOutcomeProportion <- function(d, value, others, tit=NULL) {
  if(is.null(tit)) tit <- paste(value, "proportion")
  pd <- position_dodge(width=0.35)
  d %>% 
    findOutcomeProportion(value, others) %>% 
  ggplot(aes(x=Age, y=p, group=Diagnostic, colour = Diagnostic)) +
    theme_linedraw() +
    theme(panel.grid = element_blank(), axis.text.x=element_text(angle=45, hjust=1)) +
    geom_errorbar(aes(x=Age, ymin=p_lo, ymax=p_up, colour=Diagnostic), width=0.35, position=pd) +
    geom_point(size=1.5, position=pd) +
    geom_vline(xintercept = seq(0.5,20,1), colour="grey90") +
    labs(x = "Age group", y = "Proportion", title=tit) +
    scale_colour_manual(values = cbPalette) +
    scale_y_continuous(limits=c(0,1))
}
```

```{r cases}
cases <- list(
  `1` = list(value = "direct_bc_death",
             others = c("indirect_bc_death", "unrelated_death", "unrelated_bc_death"),
             name = "Direct BC deaths / all deaths"),
  `2` = list(value = "unrelated_death",
             others = c("indirect_bc_death", "direct_bc_death", "unrelated_bc_death"),
             name = "Unrelated deaths / all deaths"),
  `3` = list(value = "direct_bc_death",
             others = c("indirect_bc_death", "unrelated_death", "unrelated_bc_death", "survival"),
             name = "Direct BC deaths / all outcomes"),
  `4` = list(value = "unrelated_death",
             others = c("indirect_bc_death", "direct_bc_death", "unrelated_bc_death", "survival"),
             name = "Unrelated deaths / all outcomes")
)
```

```{r age_death_bc_proportion, fig.width=6, fig.height=12}
map(cases, function(case) {
  plotOutcomeProportion(sdat, value = case$value, others = case$others, tit = case$name)   
}) %>% 
  plot_grid(plotlist = ., ncol=1)  
```

We see that screened patients consistently show lower breast cancer death proportion at most age groups. The unrelated deaths / all deaths are higher for screened patients, because these are essentially the inversion of the BC deaths (that is, unrelated deaths and BC deaths add up to total deaths, apart from two other categories - indirect BC death and unrelated BC death).

When we find the proportion of all outcomes, the result is much more independent. The BC deaths are much higher in symptomatic patients but unrelated deaths show very little difference between screened and symptomatic patients - this is encouraging!

## Statistical significance

Next we assess the statistical different between symptoms and screening for each plot. For this, we use a test statistic:

\[\chi^2 = \sum_{i=1}^m \frac{(p_{1,i} - p_{2,i})^2}{SE_i^2},\]

which is approximately $\chi^2$ distributed with $m-1$ degrees of freedom, where $m$ is the number of age groups used (we ignore groups where any of the counts are zero). Here $i$ is the age group index, $p_1$ and $p_2$ are proportions of deaths in symptoms and screening diagnostics, respectively and the pooled standard error, $SE_i$ is approximated by

\[SE_i^2 = SE_{1,i}^2 + SE_{2,i}^2,\]

that is from individual standard errors of each proportion. This is a conservative approximation as it is not weighted by the sample size and it will tend to overestimate errors when one of the standard errors is much larger than the other. As a result, $\chi^2$ is reduced and the $p$-value is inflated.


```{r chi2_comparison}
chi2Comparison <- function(d, value, others) {
  P <- d %>% 
    findOutcomeProportion(value, others) %>% 
    select(Age, Diagnostic, p, se) %>% 
    group_split(Diagnostic)
  cx <- inner_join(P[[1]], P[[2]], by="Age") %>% 
    mutate(se2 = se.x^2 + se.y^2, chi2 = (p.x - p.y)^2 / se2)
  chi2 <- sum(cx$chi2)
  dof <- nrow(cx) - 1
  p <- 1 - pchisq(chi2, dof)
  list(chi2 = chi2, dof = dof, p = p)
}
```


```{r chi2_table}
map_df(cases, function(case) {
  cs <- chi2Comparison(sdat, value = case$value, others = case$others)
  tibble(Group = case$name, chi2 = cs$chi2, p = cs$p)
}) %>% 
  mutate_at(vars(chi2, p), ~signif(.,3)) %>% mutate_at(vars(chi2, p), as.character) %>% 
  myKable()
```

As we mostly see very small p-values (practically zero) the p-value inflation is not a problem. We see that the first free cases are very strongly statistically significant while in the last case, which is still statistically significant at the default 0.05 limit, the effect size (can be quantified by $\chi^2$) is much smaller.

# Conclusion

Direct BC death proportions are much smaller in screened patients than in the symptomatic patients. The effect cannot be attributed to general differences between the two groups, e.g. because of a healthier life style. When we look at unrelated deaths, the difference between the two groups are much smaller.

# Alternative visualization

I replace are range with the middle of the range and fit numerical data with a third-degree polynomial, taking standard errors into account. Here is what the models look like.


```{r fit_funs}
fitPoly <- function(d, value, others, ...) {
  d %>% 
    findOutcomeProportion(value, others) %>% 
    select(x=Midage, y=p, se, Diagnostic) %>% 
    group_split(Diagnostic) %>% 
    map_df(function(w) {
      m <- nls(y ~ A + B*x + C*x^2 + D*x^3, start=list(A=0.2, B=0, C=0, D=0), weights=1/se^2, data=w)
      xd <- tibble(x=seq(min(w$x),max(w$x),1))
      tibble(Diagnostic=w$Diagnostic[1], x=xd$x, y=predict(m, xd))
    })
}

plotFitData <- function(d, value, others, FITFUN=fitPoly, ..., tit=NULL) {
  if(is.null(tit)) tit <- paste(value, "proportion")
  
  dat <- d %>% 
    findOutcomeProportion(value, others)
  
  g <- ggplot(data=dat, aes(x=Midage, y=p, group=Diagnostic, colour = Diagnostic)) +
    theme_linedraw() +
    theme(panel.grid = element_blank()) +
    geom_errorbar(aes(x=Midage, ymin=p_lo, ymax=p_up, colour=Diagnostic), width=0.2) +
    geom_point(size=1.5) +
    labs(x = "Age group", y = "Proportion", title=tit) +
    scale_colour_manual(values = cbPalette) +
    scale_y_continuous(limits=c(0,1))

  if(!is.null(FITFUN)) {
    mod <- FITFUN(d, value, others, ...)
    g <- g +   geom_line(data=mod, aes(x=x, y=y, colour=Diagnostic))
  }
  g
}
```


```{r age_model, fig.width=6, fig.height=12}
map(cases, function(case) {
  plotFitData(sdat, value = case$value, others = case$others, tit = case$name)   
}) %>%  
  plot_grid(plotlist = ., ncol=1) 
```


# Age dependence of BC deaths

Here we look how proportion of direct breast cancer deaths (vs all deaths) changes as a function of age. I do the calculation twice: once for symptomatic patients only, and then for all patients. Screened patients don't show a simple linear decrease.

From figures above we notice that the proportion of BC deaths decreases with age only above the age of about 35. Hence, we fit only ages 35+ with a linear regression.

Plots show the best fit, tables show regression parameters.

```{r time_course_fit}
timeCourseFit <- function(d, value, others, min.age=35) {
 dx <- d %>%  
    findOutcomeProportion(value, others) %>% 
    select(x=Midage, y=p, se)
 m <- nls(y ~ Intercept + Slope*x, start=list(Intercept=1, Slope=-0.1), weights=1/se^2, data=dx)
 summary(m)$coefficients %>%
   as.data.frame %>%
   rownames_to_column(var="Parameter")
}

timeCourse <- function(d, value, others, min.age=35, tit=NULL) {
  coef <- timeCourseFit(d, value, others, min.age=35)
  xx <- c(min.age, 87.5)
  mod <- tibble(x = xx, y = coef$Estimate[1] + xx * coef$Estimate[2])
  g <- plotFitData(d, value, others, FITFUN=NULL, tit=tit) +
    geom_line(data=mod, aes(x=x, y=y, group=1), colour="black")
  list(plot=g, coef=coef)
}
```

```{r time_course_symptoms, fig.width=6, fig.height=3}
d_sym <- sdat %>%
  filter(Diagnostic=="symptoms")
tc_sym <- timeCourse(d_sym, cases[[1]]$value, cases[[1]]$others, tit=cases[[1]]$name)
tc_sym$plot
tc_sym$coef %>% mutate_at(vars(-Parameter), ~sprintf("%.3g", .)) %>% myKable
```

```{r time_course_both, fig.width=6, fig.height=3}
d_both <- sdat %>% 
  group_by(Age, Outcome) %>% 
  summarise(n = sum(n), Midage = Midage[1]) %>% 
  mutate(Diagnostic = "both")
tc_both <- timeCourse(d_both, cases[[1]]$value, cases[[1]]$others, tit=cases[[1]]$name)
tc_both$plot
tc_both$coef %>% mutate_at(vars(-Parameter), ~sprintf("%.3g", .)) %>% myKable
```

In both cases the decrease in direct BC deaths proportion is about $0.012\pm0.001$, that is $(1.2\pm0.1)\%$ per year. Also, a small p-value on the slope indicates that the decrease with age is highly significant.


